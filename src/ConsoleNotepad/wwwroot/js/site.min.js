!function(){"use strict"}();var app=angular.module("ConsoleNotepad",["ngRoute"]);app.directive("ace",["$timeout",function(e){var t=function(e,t){var n=e.renderer.lineHeight,o=e.getSession().getLength;10>o&&(o=10),$(t).height(o*n),e.resize()};return{restrict:"A",require:"ngModel",scope:{ngModel:"=?"},link:function(n,o,r,a){var s=o[0],i=ace.edit(s);i.setTheme("ace/theme/monokai");var c;"Code"==r.ace?c="javascript":"View"==r.ace&&(c="html"),console.log("language: "+c),i.getSession().setMode("ace/mode/"+c),i.setShowPrintMargin(!1),n.$watch("ngModel",function(){i.getValue()!=n.ngModel&&i.setValue(n.ngModel,1)}),i.on("change",function(){e(function(){n.$apply(function(){var e=i.getValue();n.ngModel=e})}),t(i,o)})}}}]),app.directive("appendScript",function(e,t){return{restrict:"AE",scope:{noteName:"="},link:function(n,o,r){console.log("loading script "+n.noteName),e.getByTag(n.noteName).then(function(e){var o=e.data;console.table(o),n.currentNoteId=o.NoteId,n.parts=t.get(n.currentNoteId).success(function(e){console.log("Part with script received"),console.table(e),console.table(e[0]),1==e.length?(console.log("From parent"+n.evalFromParent),n.$parent.evalFromParent(e[0].Data)):console.error("Nieprawidlowa ilosc partow: "+e.length)})},null)}}}),app.directive("contenteditable",[function(){return{require:"?ngModel",scope:{},link:function(e,t,n,o){t.bind("blur keyup change",function(){e.$apply(function(){o.$setViewValue(t.html())})}),o.$render=function(){t.html(o.$viewValue)},o.$render(),e.$on("$destroy",function(){t.unbind("blur"),t.unbind("paste"),t.unbind("focus")})}}}]),app.directive("focusOn",function(e){return function(t,n,o){t.$on("focusOn",function(t,r){r===o.focusOn&&e(function(){if(n[0].focus(),"undefined"!=typeof window.getSelection&&"undefined"!=typeof document.createRange){var e=document.createRange();e.selectNodeContents(n[0]),e.collapse(!1);var t=window.getSelection();t.removeAllRanges(),t.addRange(e)}else if("undefined"!=typeof document.body.createTextRange){var o=document.body.createTextRange();o.moveToElementText(n[0]),o.collapse(!1),o.select()}})})}}),app.factory("focusOn",function(e,t){return function(n){t(function(){e.$broadcast("focusOn",n),console.log("called "+n)})}}),app.directive("keyboardShortcutsManager",function(e){return{restrict:"AE",scope:!1,link:function(t,n,o){function r(e){u=t.keysPressed[e.keyCode]!=("keydown"==e.type),t.keysPressed[e.keyCode]="keydown"==e.type,u&&(t.keysPressed[e.keyCode]?l++:l--)}function a(e){if(u&&(s(["ctrl","alt"])&&(t.jumpToWindow(),e.preventDefault()),s(["ctrl","space"])&&(t.addWindow(),e.preventDefault()),s(["ctrl","shift","space"])&&(t.removeWindow(),e.preventDefault()),s(["alt","*"]))){var n=i();t.jumpToWindow(n-1)}}function s(e){if(void 0==e||null==e||l!=e.length)return!1;for(var n in e)if(!t.keysPressed[c(e[n])]&&"*"!=e[n])return!1;return!0}function i(){for(var e=49;57>e;e++)if(t.keysPressed[e])return parseInt(String.fromCharCode(e));return-1}function c(e){switch(e){case"ctrl":return 17;case"enter":return 13;case"shift":return 16;case"alt":return 18;case"backspace":return 8;case"space":return 32;default:if(1==e.length)return e.charCodeAt(0)}}t.keysPressed=[];var u=!1,l=0;e.bind("keydown keyup",r),e.bind("keydown",a)}}}),app.directive("suggestionList",function(e,t){return{restrict:"AE",require:"ngModel",scope:{ngModel:"=?",inputId:"@",inputClass:"@",callback:"&"},link:function(t,n,o,r){function a(e){t.ngModel="";var n=t.suggestions[e];for(var o in n.NoteTags)t.ngModel+=n.NoteTags[o].Tag.Name+" ";t.callback()(n.NoteId)}t.keyDown=function(n){32==n.keyCode&&(t.suggestions=e.getSuggested(t.ngModel).then(function(e){t.suggestions=e.data},null),console.log("Suggestions refreshed")),40==n.keyCode&&t.highlightedSuggestion<t.suggestions.length-1?(n.preventDefault(),t.highlightedSuggestion++):38==n.keyCode&&t.highlightedSuggestion>-1?(n.preventDefault(),t.highlightedSuggestion--):13==n.keyCode&&(-1!=t.highlightedSuggestion?a(t.highlightedSuggestion):t.callback()()),13!=n.keyCode&&40!=n.keyCode&&38!=n.keyCode&&(t.highlightedSuggestion=-1)},t.suggestionClicked=function(e,t){1===t.which&&a(e)}},templateUrl:"/angularViews/directives/suggestionList.html"}}),app.directive("viewLoader",function(notes,parts,$compile){return{restrict:"AE",require:"ngModel",scope:{ngModel:"=?",settings:"=partSettings"},link:function(scope,elem,attrs,ngModel){function reloadView(e){void 0!=e&&""!=e&&notes.getByTag(e).then(function(e){var t=e.data,n=t.NoteId;parts.get(n).success(function(e){if(1==e.length){var t=e[0].Data;elem.html(t),$compile(elem.contents())(scope)}else console.error("Nieprawidlowa ilosc partow: "+e.length)})})}function loadScript(adress){notes.getByTag(adress).then(function(response){var noteData=response.data,currentNoteId=noteData.NoteId;parts.get(currentNoteId).success(function(data){1==data.length?eval(data[0].Data):console.error("Nieprawidlowa ilosc partow: "+data.length)})})}void 0!=scope.settings&&(scope.oldSettings=scope.settings,scope.viewAdress=void 0!=scope.settings.view?scope.settings.view:"",scope.scriptAdress=void 0!=scope.settings.script?scope.settings.script:"",reloadView(scope.viewAdress),loadScript(scope.scriptAdress)),scope.evalFromParent=function(data){console.log("Evaluated from parent"),eval(data)}}}}),app.controller("editorController",function(e,t,n,o,r,a){function s(t){e.parts[t].localState="Sending",n.put(e.parts[t]).success(function(){e.parts[t].localState="OK"}).error(function(){e.parts[t].localState="Problem"})}function i(){a(function(){void 0==e.smartBar&&(e.smartBar=""),console.log("getting parts"+e.smartBar),t.getByTag(e.smartBar).then(function(o){console.log("getPartsByTag success response"),console.dir(o),e.currentNoteId=o.data.NoteId,e.noteType=t.typeToString(o.data.TypeOfNote),console.log("$scope.noteType"+e.noteType),e.currentNoteObject=o.data,e.parts=n.get(e.currentNoteId).success(function(e){u(e)})},function(t){console.log("getPartsByTag eror response"),404==t.status&&(console.log("NIE ZNALEZIONO NOTATKI"),e.askToAddNewNote=e.smartBar)})})}function c(){(0==e.parts.length||null==e.parts)&&e.addPart()}function u(t){for(var n in t)t[n].Settings=void 0==t[n].SettingsAsJSON?{}:JSON.parse(t[n].SettingsAsJSON);e.parts=t,c()}e.windowId=0,e.suggestions={},e.showSuggestions=!1,e.highlightedSuggestion=-1,e.currentNoteId=0,e.currentNoteObject={};var l;e.activePart=0,e.noteType="Normal",i(),e.setWindowID=function(t){console.log("windowID: "+t),e.windowId=t},e.editingPartKeyDown=function(t,n){clearTimeout(l),l=setTimeout(function(){s(n)},1e3),e.parts[n].localState="Sending"},e.addPart=function(){var t=e.activePart+1;e.parts.splice(t,0,{Data:"&nbsp;",NoteID:e.currentNoteId}),o("part"+t+"window"+e.$index),e.parts[t].localState="Sending",e.parts[t].OrderPosition=e.parts[t-1].OrderPosition+1;for(var r in e.parts)r!=t&&e.parts[r].OrderPosition>=e.parts[t].OrderPosition&&e.parts[r].OrderPosition++;n.post(e.parts[t]).success(function(n){e.parts[t].ID=n.ID,e.parts[t].localState="OK"}).error(function(){e.parts[t].localState="Problem"})},e.focusedOnPart=function(t){e.activePart=t},e.suggestionListCallback=function(e){console.log("callback1"),i()},e.addNote=function(n){var o={TagsToAdd:n};t.post(o).then(function(t){e.askToAddNewNote=void 0,i(n)})},e.saveChangesToNote=function(){t.put(e.currentNoteObject).then(function(t){console.log("saving note data success"),e.smartBar=e.currentNoteObject.TagsToAdd,console.dir(t),console.log(e.smartBar),i()})},e.deleteSetting=function(t,n){delete e.parts[t].Settings[n]}}),app.factory("notes",["$http",function(e){var t={};return t.typeToString=function(e){switch(e){case 0:return"Normal";case 1:return"Code";case 2:return"View";case 3:return"System";default:return"Normal"}},t.getSuggested=function(t){return e({method:"GET",url:"/api/notes/suggested?searchText="+t,headers:{Accept:"application/json"}}).then(function(e){return e.data.TagsToAdd=e.data.TagsAsSingleString,e},function(e){throw console.error("Error while using notes.getSuggested"),console.dir(e),e})},t.getByTag=function(t){return console.log("getByTag: "+t),e({method:"GET",url:"/api/notes/bytags?searchText="+t,headers:{Accept:"application/json"}}).then(function(e){return e.data.TagsToAdd=e.data.TagsAsSingleString,e},function(e){throw console.error("Error while using notes.getByTag"),console.dir(e),e})},t.post=function(t){return e({method:"POST",url:"/api/Notes",data:t,headers:{Accept:"application/json"}}).then(null,function(e){throw console.error("Couldn't post a note"),e})},t.put=function(t){return console.table(t),e({method:"PUT",url:"/api/Notes/"+t.NoteId,data:t,headers:{Accept:"application/json"}}).then(function(e){return e},function(e){throw console.error("Couldn't put a note"),e})},t}]),app.factory("parts",["$http",function(e){var t={};return t.get=function(t){return e({method:"GET",url:"/api/parts?idOfNote="+t,headers:{Accept:"application/json"}})},t.post=function(t){return e({method:"POST",url:"/api/Parts",data:t,headers:{Accept:"application/json"}})},t.put=function(t){return console.log("Updating..."),console.table(t),void 0==t.Settings&&void 0!=t.SettingsAsJSON&&console.warn("Ustawienia part'a zosta≈Çy wyzerowane"),t.SettingsAsJSON=JSON.stringify(t.Settings),e({method:"PUT",url:"/api/Parts/"+t.ID,data:t,headers:{Accept:"application/json"}})},t}]),app.controller("windowsController",function(e,t,n,o,r){e.numberOfWindows=[0],e.preventDuplicates=1,e.activeWindow=0,e.addWindow=function(t){var n=0;void 0==t?(e.numberOfWindows.push(e.preventDuplicates),n=e.numberOfWindows.length-1):(e.numberOfWindows.splice(t+1,0,e.preventDuplicates),n=t+1),e.preventDuplicates++,e.activeWindow=n,e.jumpToWindow(n)},e.removeWindow=function(t){void 0==t&&(t=e.activeWindow),e.numberOfWindows.splice(t,1),e.jumpToWindow(t-1)},e.jumpToWindow=function(t){console.log("Active window: "+e.activeWindow),console.log("id: "+t),t<e.numberOfWindows.length?(e.activeWindow=t,r(function(){o("smartBar"+e.activeWindow)})):console.warn("Okno nie istnieje")}});