!function(){"use strict"}();var app=angular.module("ConsoleNotepad",["ngRoute"]);app.directive("ace",["$timeout",function(e){var t=function(e,t){var n=e.renderer.lineHeight,o=e.getSession().getLength;10>o&&(o=10),$(t).height(o*n),e.resize()};return{restrict:"A",require:"ngModel",scope:{ngModel:"=?"},link:function(n,o,r,i){var s=o[0],a=ace.edit(s);a.setTheme("ace/theme/monokai"),console.log("language: "+r.ace),a.getSession().setMode("ace/mode/"+r.ace),a.setShowPrintMargin(!1),n.$watch("ngModel",function(){a.getValue()!=n.ngModel&&a.setValue(n.ngModel,1)}),a.on("change",function(){e(function(){n.$apply(function(){var e=a.getValue();n.ngModel=e})}),t(a,o)})}}}]),app.directive("appendScript",function(e,t){return{restrict:"AE",scope:{noteName:"="},link:function(n,o,r){console.log("loading script "+n.noteName),e.getByTag(n.noteName).success(function(e){console.table(e),n.currentNoteId=e.NoteId,n.parts=t.get(n.currentNoteId).success(function(e){console.log("Part with script received"),console.table(e),console.table(e[0]),1==e.length?(console.log("From parent"+n.evalFromParent),n.$parent.evalFromParent(e[0].Data)):console.error("Nieprawidlowa ilosc partow: "+e.length)})})}}}),app.directive("contenteditable",[function(){return{require:"?ngModel",scope:{},link:function(e,t,n,o){t.bind("blur keyup change",function(){e.$apply(function(){o.$setViewValue(t.html())})}),o.$render=function(){t.html(o.$viewValue)},o.$render(),e.$on("$destroy",function(){t.unbind("blur"),t.unbind("paste"),t.unbind("focus")})}}}]),app.directive("focusOn",function(e){return function(t,n,o){t.$on("focusOn",function(t,r){r===o.focusOn&&e(function(){if(n[0].focus(),"undefined"!=typeof window.getSelection&&"undefined"!=typeof document.createRange){var e=document.createRange();e.selectNodeContents(n[0]),e.collapse(!1);var t=window.getSelection();t.removeAllRanges(),t.addRange(e)}else if("undefined"!=typeof document.body.createTextRange){var o=document.body.createTextRange();o.moveToElementText(n[0]),o.collapse(!1),o.select()}})})}}),app.factory("focusOn",function(e,t){return function(n){t(function(){e.$broadcast("focusOn",n),console.log("called "+n)})}}),app.directive("keyboardShortcutsManager",function(e){return{restrict:"AE",scope:!1,link:function(t,n,o){function r(e){u=t.keysPressed[e.keyCode]!=("keydown"==e.type),t.keysPressed[e.keyCode]="keydown"==e.type,u&&(t.keysPressed[e.keyCode]?d++:d--)}function i(e){if(u&&(s(["ctrl","alt"])&&(t.jumpToWindow(),e.preventDefault()),s(["ctrl","space"])&&(t.addWindow(),e.preventDefault()),s(["ctrl","shift","space"])&&(t.removeWindow(),e.preventDefault()),s(["alt","*"]))){var n=a();t.jumpToWindow(n-1)}}function s(e){if(void 0==e||null==e||d!=e.length)return!1;for(var n in e)if(!t.keysPressed[c(e[n])]&&"*"!=e[n])return!1;return!0}function a(){for(var e=49;57>e;e++)if(t.keysPressed[e])return parseInt(String.fromCharCode(e));return-1}function c(e){switch(e){case"ctrl":return 17;case"enter":return 13;case"shift":return 16;case"alt":return 18;case"backspace":return 8;case"space":return 32;default:if(1==e.length)return e.charCodeAt(0)}}t.keysPressed=[];var u=!1,d=0;e.bind("keydown keyup",r),e.bind("keydown",i)}}}),app.directive("suggestionList",function(e){return{restrict:"AE",require:"ngModel",scope:{ngModel:"=?",id:"="},link:function(e,t,n,o){e.keyDown=function(e){console.log("!!!")}},templateUrl:"/angularViews/directives/suggestionList.html"}}),app.directive("viewLoader",function(notes,parts,$compile){return{restrict:"AE",require:"ngModel",scope:{ngModel:"=?",settings:"=partSettings"},link:function(scope,elem,attrs,ngModel){function reloadView(e){void 0!=e&&""!=e&&notes.getByTag(e).success(function(e){var t=e.NoteId;parts.get(t).success(function(e){if(1==e.length){var t=e[0].Data;elem.html(t),$compile(elem.contents())(scope)}else console.error("Nieprawidlowa ilosc partow: "+e.length)})})}function loadScript(adress){notes.getByTag(adress).success(function(noteData){var currentNoteId=noteData.NoteId;parts.get(currentNoteId).success(function(data){1==data.length?eval(data[0].Data):console.error("Nieprawidlowa ilosc partow: "+data.length)})})}void 0!=scope.settings&&(scope.oldSettings=scope.settings,scope.viewAdress=void 0!=scope.settings.view?scope.settings.view:"",scope.scriptAdress=void 0!=scope.settings.script?scope.settings.script:"",reloadView(scope.viewAdress),loadScript(scope.scriptAdress)),scope.evalFromParent=function(data){console.log("Evaluated from parent"),eval(data)}}}}),app.controller("editorController",function(e,t,n,o,r){function i(t){e.parts[t].localState="Sending",n.put(e.parts[t]).success(function(){e.parts[t].localState="OK"}).error(function(){e.parts[t].localState="Problem"})}function s(){void 0==e.smartBar&&(e.smartBar=""),t.getByTag(e.smartBar).success(function(t){e.currentNoteId=t.NoteId,d(e.smartBar),e.parts=n.get(e.currentNoteId).success(function(e){u(e)})})}function a(t){e.smartBar="";var o=e.suggestions[t];console.table(o);for(var r in o.NoteTags)e.smartBar+=o.NoteTags[r].Tag.Name+" ";e.currentNoteId=o.NoteId,d(e.smartBar),n.get(e.currentNoteId).success(function(e){u(e)})}function c(){(0==e.parts.length||null==e.parts)&&e.addPart()}function u(t){for(var n in t)t[n].Settings=void 0==t[n].SettingsAsJSON?{}:JSON.parse(t[n].SettingsAsJSON);e.parts=t,c()}function d(t){var n=t.split(" "),o="";for(var r in n)if("!"==n[r].charAt(0)){o=n[r].substring(1);break}"code"==o||"c"==o?(e.noteType="javascript",e.onePartNote=!0):"view"==o||"v"==o?(e.noteType="html",e.onePartNote=!0):(e.noteType="text",e.onePartNote=!1)}e.windowId=0,e.suggestions={},e.showSuggestions=!1,e.highlightedSuggestion=-1,e.currentNoteId=0,e.parts=[{Data:"new"}];var l;e.activePart=0,e.onePartNote=!1,e.noteType="",s(),e.setWindowID=function(t){console.log("windowID: "+t),e.windowId=t},e.smartBarKeyDown=function(n){32==n.keyCode&&(e.suggestions=t.getSuggested(e.smartBar).success(function(t){console.table(t),e.suggestions=t}),console.log("Suggestions refreshed")),40==n.keyCode&&e.highlightedSuggestion<e.suggestions.length-1?(n.preventDefault(),e.highlightedSuggestion++):38==n.keyCode&&e.highlightedSuggestion>-1?(n.preventDefault(),e.highlightedSuggestion--):13==n.keyCode&&(-1!=e.highlightedSuggestion?a(e.highlightedSuggestion):s(),angular.element("#smartBar"+e.windowId).blur()),13!=n.keyCode&&40!=n.keyCode&&38!=n.keyCode&&(e.highlightedSuggestion=-1)},e.editingPartKeyDown=function(t,n){clearTimeout(l),l=setTimeout(function(){i(n)},1e3),e.parts[n].localState="Sending"},e.addPart=function(){var t=e.activePart+1;e.parts.splice(t,0,{Data:"&nbsp;",NoteID:e.currentNoteId}),o("part"+t+"window"+e.$index),e.parts[t].localState="Sending",e.parts[t].OrderPosition=e.parts[t-1].OrderPosition+1;for(var r in e.parts)r!=t&&e.parts[r].OrderPosition>=e.parts[t].OrderPosition&&e.parts[r].OrderPosition++;n.post(e.parts[t]).success(function(n){e.parts[t].ID=n.ID,e.parts[t].localState="OK"}).error(function(){e.parts[t].localState="Problem"})},e.suggestionClicked=function(e,t){1===t.which&&a(e)},e.focusedOnPart=function(t){e.activePart=t}}),app.factory("notes",["$http",function(e){var t={};return t.get=function(){},t.getSuggested=function(t){return e({method:"GET",url:"/api/notes/suggested?searchText="+t,headers:{Accept:"application/json"}})},t.getByTag=function(t){return e({method:"GET",url:"/api/notes/bytags?searchText="+t,headers:{Accept:"application/json"}})},t.post=function(e){},t.put=function(e){console.table(e)},t}]),app.factory("parts",["$http",function(e){var t={};return t.get=function(t){return e({method:"GET",url:"/api/parts?idOfNote="+t,headers:{Accept:"application/json"}})},t.post=function(t){return e({method:"POST",url:"/api/Parts",data:t,headers:{Accept:"application/json"}})},t.put=function(t){return void 0==t.Settings&&void 0!=t.SettingsAsJSON&&console.warn("Ustawienia part'a zosta≈Çy wyzerowane"),t.SettingsAsJSON=JSON.stringify(t.Settings),e({method:"PUT",url:"/api/Parts/"+t.ID,data:t,headers:{Accept:"application/json"}})},t}]),app.controller("windowsController",function(e,t,n,o,r){e.numberOfWindows=[0],e.preventDuplicates=1,e.activeWindow=0,e.addWindow=function(t){var n=0;void 0==t?(e.numberOfWindows.push(e.preventDuplicates),n=e.numberOfWindows.length-1):(e.numberOfWindows.splice(t+1,0,e.preventDuplicates),n=t+1),e.preventDuplicates++,e.activeWindow=n,e.jumpToWindow(n)},e.removeWindow=function(t){void 0==t&&(t=e.activeWindow),e.numberOfWindows.splice(t,1),e.jumpToWindow(t-1)},e.jumpToWindow=function(t){console.log("Active window: "+e.activeWindow),console.log("id: "+t),t<e.numberOfWindows.length?(e.activeWindow=t,r(function(){o("smartBar"+e.activeWindow)})):console.warn("Okno nie istnieje")}});